name: Build, Test and Deploy to AWS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'Bolt.API/Bolt.API.csproj'
  TEST_PROJECT_PATH: 'Bolt.Tests.Unit/Bolt.Tests.Unit.csproj'
  AWS_REGION: 'eu-north-1'
  AWS_ACCOUNT_ID: '425210931122' 

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build solution
      run: dotnet build --configuration Release --no-restore
    
    - name: Run tests
      run: dotnet test --configuration Release --no-build --verbosity normal
    
    - name: Create deployment package
      run: |
        # Include .ebextensions folder
        mkdir -p ./publish/.ebextensions
        cp -r ./.ebextensions/* ./publish/.ebextensions/
        
        # Publish the app
        cd Bolt.API
        dotnet publish -c Release -o ../publish
        cd ..
        
        # Create zip (important: zip from INSIDE publish folder)
        cd publish
        zip -r ../deployment.zip .
        cd ..
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: ./deployment.zip
  
  deploy-to-aws:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: deployment-package
        path: ./
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Upload to S3
      run: |
        S3_BUCKET="elasticbeanstalk-${{ env.AWS_REGION }}-${{ env.AWS_ACCOUNT_ID }}"
        S3_KEY="bolt-api/deployment-${{ github.run_number }}.zip"
        
        # Create bucket if doesn't exist
        aws s3 mb s3://$S3_BUCKET --region ${{ env.AWS_REGION }} || true
        
        # Upload zip to S3
        aws s3 cp deployment.zip s3://$S3_BUCKET/$S3_KEY
    
    - name: Create and Deploy EB Application Version
      run: |
        VERSION_LABEL="v${{ github.run_number }}-${{ github.sha:0:8 }}"
        S3_BUCKET="elasticbeanstalk-${{ env.AWS_REGION }}-${{ env.AWS_ACCOUNT_ID }}"
        S3_KEY="bolt-api/deployment-${{ github.run_number }}.zip"
        
        # Create application version
        aws elasticbeanstalk create-application-version \
          --application-name bolt-api \
          --version-label "$VERSION_LABEL" \
          --source-bundle "S3Bucket=$S3_BUCKET,S3Key=$S3_KEY" \
          --region ${{ env.AWS_REGION }}
        
        # Wait a moment for version to be ready
        sleep 10
        
        # Deploy to environment
        aws elasticbeanstalk update-environment \
          --application-name bolt-api \
          --environment-name bolt-api-env \
          --version-label "$VERSION_LABEL" \
          --region ${{ env.AWS_REGION }}
        
        echo "Deployment started! Check AWS Console for progress."